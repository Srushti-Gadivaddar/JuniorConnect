<% layout("/layouts/boilerplate") %>
<style>
:root {
    --bg: #f5f7fb;
    --card-bg: #ffffff;
    --text-color: #0b2347;
    --btn-color: #2f5589;
    --btn-text: #ffffff;
}

[data-theme="dark"] {
    --bg: #0f172a;
    --card-bg: #1e293b;
    --text-color: #e2e8f0;
    --btn-color: #334155;
    --btn-text: #e2e8f0;
}

body {
    background: var(--bg);
    color: var(--text-color);
    font-family: 'Inter', sans-serif;
}

/* Card layout */
.edit-post-card {
    max-width: 900px;
    margin: 40px auto;
    background: var(--card-bg);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

/* Form Steps */
.step {
    display: none;
}
.step.active {
    display: block;
}

/* Buttons */
.btn-primary, .btn-next {
    background-color: var(--btn-color);
    color: var(--btn-text);
    border: none;
    border-radius: 8px;
    margin-top: 15px;
    transition: 0.2s;
}
.btn-primary:hover, .btn-next:hover {
    background-color: darken(var(--btn-color), 10%);
    transform: translateY(-2px);
}

.btn-secondary, .btn-prev {
    background-color: #6c757d;
    color: #fff;
    border-radius: 8px;
    margin-top: 15px;
}

/* Input & Textarea */
.form-control {
    border-radius: 8px;
    padding: 10px;
    border: 1px solid #ced4da;
}
.form-control:focus {
    border-color: var(--btn-color);
    box-shadow: 0 0 0 0.2rem rgba(47,85,137,0.25);
}

/* Image Grid */
.image-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 10px;
}
.image-grid img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.image-grid img:hover {
    transform: scale(1.05);
}

/* Lightbox */
#lightboxOverlay {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.8);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:1000;
}
#lightboxOverlay img {
    max-width:80%;
    max-height:80%;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.5);
}
#lightboxOverlay span {
    position:absolute;
    top:20px;
    right:30px;
    font-size:30px;
    color:white;
    cursor:pointer;
}

/* Step Headers */
.edit-post-card h2, .edit-post-card h5 {
    color: var(--text-color);
}

/* Responsive */
@media (max-width: 768px) {
    .image-grid img { width: 100px; height: 100px; }
}
</style>


<div class="edit-post-card">
    <h2 class="mb-4 text-center">Edit Post</h2>

    <form id="editPostForm" action="/profiles/<%= profile._id %>/posts/<%= post._id %>/?_method=PUT" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>

        <!-- Step 1: Post Info -->
        <div class="step active" id="step1">
            <div class="mb-4">
                <label class="form-label">Title</label>
                <input type="text" name="post[title]" value="<%= post.title %>" class="form-control" required>
                <div class="invalid-feedback">Please enter a title.</div>
            </div>
            <div class="mb-4">
                <label class="form-label">Content</label>
                <textarea name="post[content]" class="form-control" rows="4" required><%= post.content %></textarea>
            </div>
            <button type="button" class="btn btn-primary btn-next">Next</button>
        </div>

        <!-- Step 2: Images -->
        <div class="step" id="step2">
            <h5 class="mb-2">Images (Max 3)</h5>
            <div class="image-grid" id="imageGrid">
                <% if (post.images && post.images.length > 0) { %>
                    <% post.images.forEach(img => { %>
                        <div>
                            <img src="<%= img.url %>" data-filename="<%= img.filename %>" alt="post image">
                            <div class="text-center mt-1">
                                <input type="checkbox" name="deleteImages" value="<%= img.filename %>"> Delete
                            </div>
                        </div>
                    <% }) %>
                <% } %>
            </div>
            <div class="mb-3 mt-2">
                <label class="form-label">Add New Images</label>
                <input type="file" id="newImages" name="postImages" class="form-control" multiple>
                <small class="text-muted">You can only have up to 3 images total.</small>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-prev">Back</button>
                <button type="button" class="btn btn-primary btn-next">Next</button>
            </div>
        </div>

        <!-- Step 3: Preview & Submit -->
        <div class="step" id="step3">
            <h5>Preview</h5>
            <p><strong>Title:</strong> <span id="previewTitle"></span></p>
            <p><strong>Content:</strong> <span id="previewContent"></span></p>
            <div class="image-grid" id="previewImages"></div>
            <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-secondary btn-prev">Back</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </div>

    </form>
</div>

<!-- Lightbox -->
<div id="lightboxOverlay">
    <span id="closeLightbox">&times;</span>
    <img id="lightboxImg" src="">
</div>

<script>
const steps = document.querySelectorAll(".step");
let currentStep = 0;

const btnNext = document.querySelectorAll(".btn-next");
const btnPrev = document.querySelectorAll(".btn-prev");

btnNext.forEach(btn => btn.addEventListener("click", () => {
    if (!validateStep(currentStep)) return;
    steps[currentStep].classList.remove("active");
    currentStep++;
    if(currentStep >= steps.length) currentStep = steps.length - 1;
    steps[currentStep].classList.add("active");
    if(currentStep === 2) updatePreview();
}));

btnPrev.forEach(btn => btn.addEventListener("click", () => {
    steps[currentStep].classList.remove("active");
    currentStep--;
    if(currentStep < 0) currentStep = 0;
    steps[currentStep].classList.add("active");
}));

function validateStep(step) {
    let inputs = steps[step].querySelectorAll("input, textarea");
    let valid = true;
    inputs.forEach(input => {
        if(!input.checkValidity()) valid = false;
        input.classList.add("was-validated");
    });
    return valid;
}

// Update preview for Step 3
function updatePreview() {
    document.getElementById("previewTitle").innerText = document.querySelector("input[name='post[title]']").value;
    document.getElementById("previewContent").innerText = document.querySelector("textarea[name='post[content]']").value;

    const previewImages = document.getElementById("previewImages");
    previewImages.innerHTML = "";

    const allImages = Array.from(document.querySelectorAll("#imageGrid img"));
    allImages.forEach(img => {
        const checkbox = img.nextElementSibling?.querySelector("input[type=checkbox]");
        if(!checkbox || !checkbox.checked) {
            const newImg = document.createElement("img");
            newImg.src = img.src;
            newImg.style.width = "100px";
            newImg.style.height = "100px";
            newImg.style.borderRadius = "8px";
            newImg.style.objectFit = "cover";
            previewImages.appendChild(newImg);
        }
    });
}

// New images preview
const newImagesInput = document.getElementById("newImages");
const imageGrid = document.getElementById("imageGrid");
const MAX_IMAGES = 3;

function updatePreviewImages() {
    let existing = Array.from(imageGrid.querySelectorAll("img")).filter(img => {
        const checkbox = img.nextElementSibling?.querySelector("input[type=checkbox]");
        return !checkbox || !checkbox.checked;
    }).length;

    const files = Array.from(newImagesInput.files);
    if(existing + files.length > MAX_IMAGES) {
        alert(`Max ${MAX_IMAGES} images allowed.`);
        newImagesInput.value = "";
        return;
    }

    Array.from(imageGrid.querySelectorAll(".new-preview")).forEach(el => el.remove());
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            const div = document.createElement("div");
            div.classList.add("new-preview");
            div.innerHTML = `<img src="${e.target.result}">`;
            imageGrid.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
}
newImagesInput.addEventListener("change", updatePreviewImages);

// Lightbox
const lightboxOverlay = document.getElementById("lightboxOverlay");
const lightboxImg = document.getElementById("lightboxImg");
const closeLightbox = document.getElementById("closeLightbox");

imageGrid.addEventListener("click", e => {
    if(e.target.tagName === "IMG") {
        lightboxImg.src = e.target.src;
        lightboxOverlay.style.display = "flex";
    }
});
closeLightbox.addEventListener("click", () => lightboxOverlay.style.display = "none");
lightboxOverlay.addEventListener("click", e => {
    if(e.target === lightboxOverlay) lightboxOverlay.style.display = "none";
});
</script>
