<% layout("/layouts/boilerplate") %>

<style>
:root {
  --chat-bg: #f5f7fa;
  --bubble-left: #ffffff;
  --bubble-right: #d1e7ff;
  --bubble-shadow: rgba(0,0,0,0.15);
  --header-bg: #ffffff;
  --input-bg: #ffffff;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
  --btn-success-bg: #34d399;
  --btn-success-hover: #10b981;
  --btn-danger-bg: #f87171;
  --btn-danger-hover: #ef4444;
  --dropzone-bg: rgba(0,0,0,0.03);
}

[data-theme="dark"] {
  --chat-bg: #0f172a;
  --bubble-left: #1e293b;
  --bubble-right: #334155;
  --bubble-shadow: rgba(255,255,255,0.05);
  --header-bg: #1e293b;
  --input-bg: #1e293b;
  --text-primary: #e2e8f0;
  --text-secondary: #cbd5e1;
  --btn-success-bg: #059669;
  --btn-success-hover: #047857;
  --btn-danger-bg: #dc2626;
  --btn-danger-hover: #b91c1c;
  --dropzone-bg: rgba(255,255,255,0.05);
}

body { background-color: var(--chat-bg); color: var(--text-primary); font-family: "Segoe UI", sans-serif; }

h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; }

form {
  background-color: var(--bubble-left);
  padding: 2rem;
  border-radius: 1rem;
  box-shadow: 0 4px 15px var(--bubble-shadow);
  max-width: 700px;
  margin: 0 auto 2rem auto;
}

label { font-weight: 600; margin-bottom: 0.4rem; display: block; color: var(--text-primary); }

input.form-control, textarea.form-control {
  width: 100%; padding: 0.6rem 0.8rem; border-radius: 0.6rem;
  border: 1px solid rgba(0,0,0,0.15); background-color: var(--input-bg);
  color: var(--text-primary); font-size: 1rem; transition: border 0.2s ease, box-shadow 0.2s ease;
}

[data-theme="dark"] input.form-control, [data-theme="dark"] textarea.form-control {
  border: 1px solid rgba(255,255,255,0.2); background-color: var(--input-bg); color: var(--text-primary);
}

input.form-control:focus, textarea.form-control:focus { outline: none; border-color: var(--bubble-right); box-shadow: 0 0 6px var(--bubble-shadow); }

button.btn-success {
  background-color: var(--btn-success-bg); color: #fff; border: none;
  font-weight: 600; padding: 0.6rem 1.2rem; border-radius: 0.6rem; cursor: pointer;
  transition: transform 0.15s ease, background-color 0.2s ease, box-shadow 0.2s ease;
}

button.btn-success:hover { background-color: var(--btn-success-hover); transform: translateY(-2px); box-shadow: 0 4px 12px var(--bubble-shadow); }

button.btn-danger {
  background-color: var(--btn-danger-bg); color: #fff; border: none;
  font-weight: 500; padding: 0.4rem 0.8rem; border-radius: 0.5rem; cursor: pointer;
  transition: background-color 0.2s ease, transform 0.15s ease;
}

button.btn-danger:hover { background-color: var(--btn-danger-hover); transform: translateY(-1px); }

.dropzone {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  border: 2px dashed var(--text-secondary); border-radius: 0.6rem; padding: 1rem;
  background-color: var(--dropzone-bg); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease;
  margin-bottom: 1rem; text-align: center;
}

.dropzone:hover { background-color: var(--bubble-left); border-color: var(--text-primary); }

.dropzone i { font-size: 1.4rem; color: var(--text-secondary); }
.dropzone span { font-size: 0.95rem; color: var(--text-primary); }
input[type="file"] { display: none; }

.media-preview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 0.5rem; }
.media-preview img { max-width: 120px; border-radius: 0.6rem; box-shadow: 0 2px 8px var(--bubble-shadow); cursor: pointer; }
.media-item { text-align: center; }

/* Lightbox */
#lightbox {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); justify-content: center; align-items: center;
  z-index: 9999; overflow: hidden;
}

#lightbox img { max-width: 90%; max-height: 90%; border-radius: 0.5rem; }

#lightbox .close, #lightbox .prev, #lightbox .next {
  position: absolute; top: 50%; transform: translateY(-50%);
  color: #fff; font-size: 2rem; cursor: pointer; user-select: none; padding: 0.5rem 1rem;
}

#lightbox .close { top: 10px; right: 20px; transform: none; font-size: 2.2rem; }
#lightbox .prev { left: 20px; }
#lightbox .next { right: 20px; }

</style>

<center><h2>Edit Question</h2></center>

<form action="/questions/<%= question._id %>?_method=PUT" method="POST" enctype="multipart/form-data">

  <div class="form-group">
    <label for="title">Title</label>
    <input id="title" name="title" value="<%= question.title %>" class="form-control" />
  </div>

  <div class="form-group">
    <label for="body">Body</label>
    <textarea id="body" name="body" rows="8" class="form-control"><%= question.body %></textarea>
  </div>

  <label>Add Images</label>
  <div class="dropzone" onclick="document.getElementById('images').click()">
    <i class="fa-solid fa-camera"></i>
    <span>Drag & drop images here or click to select</span>
    <input type="file" id="images" name="images" multiple accept="image/*">
  </div>

  <div id="imagePreview" class="media-preview"></div>

  <label>Add Files</label>
  <div class="dropzone" onclick="document.getElementById('files').click()">
    <i class="fa-solid fa-file"></i>
    <span>Drag & drop files here or click to select</span>
    <input type="file" id="files" name="files" multiple>
  </div>

  <div id="filePreview" class="media-preview"></div>

  <button class="btn btn-success" type="submit">Save</button>
</form>

<hr />
<h4>Existing Images</h4>
<div class="media-preview">
  <% if (question.images && question.images.length) { %>
    <% question.images.forEach(img => { %>
      <div class="media-item">
        <img src="<%= img.url %>" alt="Image" class="clickable-img"/>
        <form method="POST" action="/questions/<%= question._id %>/images/<%= encodeURIComponent(img.filename) %>/delete">
          <button class="btn btn-danger mt-1">Remove</button>
        </form>
      </div>
    <% }) %>
  <% } %>
</div>

<hr />
<h4>Existing Files</h4>
<ul class="mt-2">
  <% if (question.files && question.files.length) { %>
    <% question.files.forEach(f => { %>
      <li style="margin-bottom:0.5rem;">
        <a href="<%= f.url %>" download="<%= f.filename %>" style="color: var(--text-primary); text-decoration:none;"><%= f.filename %></a>
        <form method="POST" action="/questions/<%= question._id %>/files/<%= encodeURIComponent(f.filename) %>/delete" style="display:inline;">
          <button class="btn btn-danger btn-sm">Remove</button>
        </form>
      </li>
    <% }) %>
  <% } %>
</ul>

<!-- Lightbox modal -->
<div id="lightbox">
  <span class="close">&times;</span>
  <span class="prev">&#10094;</span>
  <span class="next">&#10095;</span>
  <img src="" alt="Preview">
</div>

<script>
  // Image preview for new uploads
  const imageInput = document.getElementById('images');
  const imagePreview = document.getElementById('imagePreview');
  imageInput.addEventListener('change', () => {
    imagePreview.innerHTML = '';
    Array.from(imageInput.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const imgDiv = document.createElement('div');
        imgDiv.classList.add('media-item');
        const img = document.createElement('img');
        img.src = e.target.result;
        img.classList.add('clickable-img');
        imgDiv.appendChild(img);
        imagePreview.appendChild(imgDiv);
      };
      reader.readAsDataURL(file);
    });
  });

  // File preview
  const fileInput = document.getElementById('files');
  const filePreview = document.getElementById('filePreview');
  fileInput.addEventListener('change', () => {
    filePreview.innerHTML = '';
    Array.from(fileInput.files).forEach(file => {
      const div = document.createElement('div');
      div.classList.add('media-item');
      const span = document.createElement('span');
      span.textContent = file.name;
      div.appendChild(span);
      filePreview.appendChild(div);
    });
  });

  // Lightbox functionality
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = lightbox.querySelector('img');
  const closeBtn = lightbox.querySelector('.close');
  const prevBtn = lightbox.querySelector('.prev');
  const nextBtn = lightbox.querySelector('.next');

  let currentImages = [];
  let currentIndex = 0;

  function openLightbox(images, index) {
    currentImages = images;
    currentIndex = index;
    lightboxImg.src = currentImages[currentIndex].src;
    lightbox.style.display = 'flex';
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % currentImages.length;
    lightboxImg.src = currentImages[currentIndex].src;
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
    lightboxImg.src = currentImages[currentIndex].src;
  }

  closeBtn.onclick = () => lightbox.style.display = 'none';
  nextBtn.onclick = showNext;
  prevBtn.onclick = showPrev;

  document.querySelectorAll('.clickable-img').forEach((img, i, arr) => {
    img.addEventListener('click', () => openLightbox(Array.from(document.querySelectorAll('.clickable-img')), Array.from(document.querySelectorAll('.clickable-img')).indexOf(img)));
  });

  // Also bind dynamically added images
  const observer = new MutationObserver(() => {
    document.querySelectorAll('.clickable-img').forEach((img, i, arr) => {
      if (!img.dataset.bound) {
        img.dataset.bound = true;
        img.addEventListener('click', () => openLightbox(Array.from(document.querySelectorAll('.clickable-img')), Array.from(document.querySelectorAll('.clickable-img')).indexOf(img)));
      }
    });
  });
  observer.observe(imagePreview, { childList: true });
</script>
